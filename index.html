<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>JS-Interpreter Demo</title>
  <link href="demos/style.css" rel="stylesheet" type="text/css">

  <script>
    // Depending on the URL argument, test the compressed or uncompressed version.
    var compressed = (document.location.search == '?compressed');
    if (compressed) {
      document.write('<scr' + 'ipt src="acorn_interpreter.js"></scr' + 'ipt>');
    } else {
      document.write('<scr' + 'ipt src="acorn.js"></scr' + 'ipt>');
      document.write('<scr' + 'ipt src="interpreter.js"></scr' + 'ipt>');
    }

    var myInterpreter;
    function initAlert(interpreter, scope) {
      var wrapper = function (text) {
        return alert(arguments.length ? text : '');
      };
      interpreter.setProperty(scope, 'alert',
        interpreter.createNativeFunction(wrapper));
    }

    function parseButton() {
      var code = document.getElementById('code').value;
      myInterpreter = new Interpreter(code, initAlert);
      disable('');
      selectActiveNode()
    }

    function selectActiveNode() {
      let stack = myInterpreter.stateStack;
      if (stack.length) {
        let node = stack[stack.length - 1].node;
        createSelection(node.start, node.end);
      } else {
        createSelection(0, 0);
      }
    }

    function stepButton() {
      try {
        var ok = myInterpreter.step();
        selectActiveNode();
      } finally {
        if (!ok) {
          disable('disabled');
        }
      }
    }

    function runButton() {
      disable('disabled');
      if (myInterpreter.run()) {
        // Async function hit.  There's more code to run.
        disable('');
      }
    }

    function disable(disabled) {
      document.getElementById('stepButton').disabled = disabled;
      document.getElementById('runButton').disabled = disabled;
    }

    function createSelection(start, end) {
      var field = document.getElementById('code');
      if (field.createTextRange) {
        var selRange = field.createTextRange();
        selRange.collapse(true);
        selRange.moveStart('character', start);
        selRange.moveEnd('character', end);
        selRange.select();
      } else if (field.setSelectionRange) {
        field.setSelectionRange(start, end);
      } else if (field.selectionStart) {
        field.selectionStart = start;
        field.selectionEnd = end;
      }
      field.focus();
    }
  </script>
</head>

<body>
  <p>
    <textarea id="code">var result = fibonacci(16)

function fibonacci(n) {
  var fibs = []
  var a = 1
  var b = 1
  for (var i = 0; i < n; i++) {
    fibs.push(a)
    var sum = a + b
    a = b
    b = sum
  }
  return fibs
}

alert(result.join(', '));</textarea>
    <br>
    <button onclick="parseButton()">Parse</button>
    <button onclick="stepButton()" id="stepButton" disabled="disabled">Step</button>
    <button onclick="runButton()" id="runButton" disabled="disabled">Run</button>
  </p>

</body>

</html>